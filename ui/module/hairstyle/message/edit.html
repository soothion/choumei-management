<!DOCTYPE html>
<html lang="zh-CN">
  <head>
      <meta charset="utf-8">
	  <title>臭美管理后台</title>
	  <script type="text/javascript" src="/js/include.js"></script>
  </head>
  <body>
		<div class="breadcrumb">
		<a>消息管理</a><span>&gt;</span><a href="index.html">申请消息</a> 
			<div class="flex-box">
			 <div class="flex-item">
				<h4>消息列表</h4>
			</div>
		 </div>		
		<hr />
	</div>	
	
	<div class="wrapper" ajat="<%if(query.id){%>message/getOne?id=<%=query.id%><%}%>#domid=form&tempid=form-t" id="form">
		<script type="text/template" id="form-t">
		<form novalidate method="post" class="form-vertical" data-role="form" action="<%=query._?"message/update":"message/create"%>" data-xss="none">
                 <div class="control-group">
                    <label class="control-label">发送对象：</label>
					<div class="control">
						<label>
							<input type="radio" class="radio" name="receive_type" value="1"
							<%=!data.receive_type||data.receive_type==1 ? "checked" : "" %>>
							<span>所有臭美发型app安装用户</span>
						</label>
						<br/>
						<label>
							<input type="radio" class="radio" name="receive_type" value="2" 
							<%=data.receive_type==2 ? "checked" : "" %>>
							<span>个别手机号码</span> 
						</label>
						<br />
						<style type="text/css">
							.editor-validate{
								border-width:1px;
								border-style:solid;
								display:inline-block;
								width:400px;
								height:auto;
								border-radius:3px;
								min-height:74px;
								padding:5px 10px;
								margin-top:10px;
							}
							.editor-validate li{
								line-height:1;
							}
							.editor-validate input{
								border:0!important;
								box-shadow:none!important;
								line-height:24px;
								height:24px;
								padding:0px;
								min-width:0px!important;
								width:160px!important;
							}
							.editor-validate .control-help{
								display:none;
								line-height:24px;
							}
						</style>
						<div class="editor-validate input untransition" style="<%=!data.receive_type||data.receive_type==1 ? "display:none;" : "" %>">
							<ul>
								<%if(!data.receivers){
									data.receivers="";
									}
								%>
								<%data.receivers.split(",").forEach(function(item){%>
								<li>
									<input type="text" id="er-1" value="<%=item%>" required requiredmsg="请输入手机号码" pattern="mobile" patternmsg="手机号码不正确" /><label class="control-help" for="er-1"></label>
								</li>
								<%})%>
							</ul>
							
						</div>
						<input type="hidden" name="receivers" id="receivers" />
					</div>
                </div>  
				<div class="control-separation">
                    <legend>消息编辑-列表</legend>
					<hr />
                </div>	
                <div class="control-group">
                    <label class="control-label" for=""><span class="red">*</span>标题：</label>
                    <div class="control">
                        <input type="text" required maxlength="32" name="title" value="<%=data.title%>">
						<span class="weak">(限制32字以内)</span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for=""><span class="red">*</span>摘要：</label>
                    <div class="control">
					<input type="text" required maxlength="32" name="description" value="<%=data.description%>">
					<span class="weak">(限制32字以内)</span>
					</div>
                </div>
				 <div class="control-group">
                    <label class="control-label" for=""><span class="red">*</span>列表展示图片：</label>
					<div class="control">
						<!--
						 <div class="control-image">
								<div class="control-thumbnails" data-max="2"></div>
								<div class="control-image-upload">
									<div id="imageUpload">
										<i class="fa fa-image"></i>
										<em>上传列表图片</em>
									</div>
								</div>
							</div>
						 <span class="space"></span>
						 <span class="weak">图片规格：2M以内，支持jpg、png格式</span>
						 <br />
						 <input type="checkbox" class="hide" name="images"  requiredmsg="请上传图片" />
						 -->
						  <div class="control-image">
								<div class="control-single-image">
									<img src="<%=data.img%>" alt="" />
									<div class="control-image-ud">
										<div id="imageUpload"><i class="fa fa-cloud-upload"></i>上传图片</div>
									</div>
								</div>
							</div>
						 <span class="space"></span>
						 <span class="weak">图片规格：2M以内，支持jpg、png格式</span>
						 <br />
						<input type="hidden" name="img" value="<%=data.img%>" required requiredmsg="请上传图片">
					</div>
                </div>
				<div class="control-separation">
                    <legend>消息编辑-详情</legend>
					<hr />
                </div>
				<div class="control-group">
                    <label class="control-label" for=""><span class="red">*</span>消息内容：</label>
					<div class="control">
						<label>
							<input type="radio" name="switch1" value="1" class="radio-editor"
							<%=data.url||!data.content ? "checked" : "" %>>
							<span>信息链接</span>
						</label>
						<label>
							<input type="radio" name="switch1" value="2" class="radio-editor"
							<%=data.content ? "checked" : "" %>>
							<span>编辑生成</span>
						</label>
						<div style="margin-top:10px">
							<input type="text"  id="url"/>
							<div id="editor" type="text/plain" style="width:800px;height:300px;"></div>
						</div>
						<input type="hidden" id="hidden" required />
						<br />
					</div>
                </div>  
				<div class="control-group">
					<label class="control-label" for=""></label>
					<div class="control">
						<button class="btn-primary" type="submit" id="submit">提交</button>
						<span class="space"></span>
						<button class="btn" type="submit" id="preview">预览</button>
					</div>
				</div>
		  </form>
		  </script>
		 
	</div>
		<script type="text/javascript" src="/ueditor/ueditor.config.js"></script>
		<script type="text/javascript" src="/ueditor/_examples/editor_api.js"></script>
		<script type="text/javascript" src="/ueditor/lang/zh-cn/zh-cn.js"></script>
        <script type="text/javascript">
			$('#form').one('_ready',function(){
				var form=$(this).find('form');
				window.ue = UE.getEditor('editor');
				$('#editor').hide();
				
				$('#preview').on('click',function(){
					var action=form.attr('action');
					form.attr('action','message/addingPreview/');
					setTimeout(function(){
						form.attr('action',action);
					},1000);
					$('#ueditor_textarea_editorValue').removeAttr('name');
					var val=$('.radio-editor:checked').val();
					if(val==1){
						$('#hidden').attr('name','url').val($('#url').val());
					}
					if(val==2){
						$('#hidden').attr('name','content').val(window.ue.getContent());
					}
					form.one('success',function(e,data){
						if(data.result==1&&data.data){
							window.open('preview.html?key='+data.data,'_blank');
						}
					});
				});
				$('#submit').on('click',function(){
					var val=$('.radio-editor:checked').val();
					if(val==1){
						$('#hidden').attr('name','url').val($('#url').val());
					}
					if(val==2){
						$('#hidden').attr('name','content').val(window.ue.getContent());
					}
				})
				
				
				$('.editor-validate').on('keydown','input',function(e){
					var $this=$(this);
					if(e.keyCode==13){
						var id="er-"+e.timeStamp;
						var clone=$this.closest('li').clone();
						clone.children('input').attr('id',id).val('');
						clone.children('label').attr('for',id).removeAttr('style').text('');
						$this.closest('ul').append(clone);
						clone.children('input').focus();
						e.preventDefault();
					}
				}).on('keyup','input',function(e){
					var $this=$(this);
					if(e.keyCode==8&&$.trim($this.val())==''){
						if($this.closest('li').siblings().length!=0){
							if($this.closest('li').prev().length==1){
								$this.closest('li').prev().children('input').focus();
							}else if($this.closest('li').next().length==1){
								$this.closest('li').next().children('input').focus();
							}
							$this.closest('li').remove();
						}
					}
					if(e.keyCode==38){
						if($this.closest('li').prev().length==1){
							$this.closest('li').prev().children('input').focus();
						}
					}
					if(e.keyCode==40){
						if($this.closest('li').next().length==1){
							$this.closest('li').next().children('input').focus();
						}
					}
				}).on('focus','input',function(){
					$(this).closest('.editor-validate').addClass('focus');
				}).on('pass','input',function(){
					var $this=$(this);
					$this.closest('.editor-validate').removeClass('focus');
					lib.ajax({
						url:'message/checkPhone',
						type:'POST',
						data:{
							receivers:$(this).val()
						},
						success:function(data){
							if(data.result==1&&data.data&&data.data.length>0){
								$this.trigger('error',{type:'error',errormsg:'没有找到该号码的发型师'})
							}
						}
					});
				}).on('click',function(e){
					var $target=$(e.target);
					if($target.is('li')){
						target.children('input').addClass('focus');
					}
					if($target.is('div')){
						$(this).find('input').last().focus();
					}
				});
			});
			
			lib.puploader.image({
				browse_button: 'imageUpload',
				auto_start:true,
				postName:"img",
				filters: {
				    mime_types : [
						{ title : "Image files", extensions : "jpg,gif,png,jpeg" },
					],
					max_file_size:'2mb'
                },
				init:{}
			});
			
			setTimeout(function(){
				$('#edui148 .edui-icon').attr('id','ueditor-upload');
				lib.puploader.image({
					browse_button: 'ueditor-upload',
					auto_start:true,
					postName:"src",
					filters: {
						mime_types : [
							{ title : "Image files", extensions : "jpg,gif,png,jpeg" },
						]
					},
					init:{
						
					}
				},function(uploader){
					uploader.bind('FileUploaded',function(up,file,res){
						if(res&&res.response&&typeof res.response=='string'){
							var data=JSON.parse(res.response);
							if(data.code==0&&data.response)
							UE.getEditor('editor').execCommand('insertHtml','<img src="'+data.response.img +'"/>');
						}
					});
				});
			},2000);
			/*
			lib.uploader.image({
				auto:true,
				server: "http://service.choumei.cn/upload/image",
				pick  : {id:'#imageUpload',multiple:false},
				resize: false,
				fileSingleSizeLimit : 2*1024*1024,
				//imageLimitSize:"512*512",
				imageLimitSize:function(width,height){
					return true
				},
				accept :{
					title: 'Images',
					extensions: 'jpg,jpeg,png',
					mimeTypes: 'image/jpeg,image/png'                
				},
				postName:'images'
			},function(uploader){
				
			});*/
			$(document).on('change','.radio',function(){
				var val=$(this).val();
				var editor=$('.editor-validate');
				if(val==2){
					editor.slideDown(200);
					editor.find('input').last().focus();
				}else{
					editor.slideUp(200);
				}
			}).on('change','.radio-editor',function(){
				var editor=$('#editor');
				if($(this).val()==1){
					editor.hide().prev().show();
				}else{
					editor.show().prev().hide();
				}
			});
		</script>  
  </body>
</html>