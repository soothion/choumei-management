<!DOCTYPE html>
<html lang="zh-CN">
  <head>
      <meta charset="utf-8">
	  <title>臭美管理后台</title>
	  <script type="text/javascript" src="/js/include.js"></script>
  </head>
  <body>
	<div class="breadcrumb">
		<a>店铺管理 </a><span>&gt;</span><a href="../index.html">店铺资料</a><span>&gt;</span><%=query.id?"编辑":"新增"%>项目
		<div class="flex-box">
			<div class="flex-item">
				<h4><%=query.id?"编辑":"新增"%>项目-<%=query.salonname%></h4>
			</div>
		</div>
		<hr />
	</div>
	<div class="wrapper" >
		<div ajat="<%if(query.id){%>merchant/getMerchantList?id=<%=query.id%><%}%>#domid=form&tempid=form-t" id="form">
		<script type="text/template" id="form-t">
		<form method="post" class="form-vertical" data-role="form" action="<%=query.id?"merchant/update":"itemInfo/create"%>">
			<div class="detail-operation">
				<button class="btn btn-cancel" type="button">取消</button>
				<span class="space"></span>
				<button class="btn-primary" data-slug="<%=query._?"merchant.update":"merchant.save"%>">提交</button>
			</div>
			<%if(query.p=="special"){%>
			<legend>新增方式</legend>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>选择分类：</label>
				<div class="control">
					<select ajat="salonList/getItemType#domid=type1&tempid=type1-t" id="type1" 
						ajat-change="itemInfo/getItems?salonid=<%=query.salonid%>&typeid=${value}#domid=project&tempid=project-t">
					</select>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>已有项目：</label>
				<div class="control">
					<select id="project"></select>
				</div>
			</div>
			<hr />
			<%}%>
			<input type="hidden" name="itemType" value="<%=query.p=="special"?"2":"1"%>" />
			<input type="hidden" name="salonid" value="<%=query.salonid%>" />
			<legend>项目资料</legend>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>项目名称：</label>
				<div class="control">
					<input type="text" required name="itemname" maxlength="15" nospace>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>项目分类：</label>
				<div class="control">
					<select ajat="salonList/getItemType#domid=type&tempid=type-t" id="type" name="typeid"
					ajat-change="itemInfo/getAddedService?salonid=<%=query.salonid%>&typeid=${value}#domid=service&tempid=service-t">
					</select>
				</div>
			</div>
			<div class="control-group" style="display:none" id="level">
				<label class="control-label" for=""><span class="red">*</span>快剪等级：</label>
				<div class="control">
					<select name="fastGrade">
						<option value="1">普通快剪</option>
						<option value="2">总监快剪</option>				
					</select>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>项目图片：</label>
				<div class="control">
					<div class="control-image">
						<div class="control-single-image">
							<img src="" alt="">
							<div class="control-image-ud">
								<div id="imageUpload"><i class="fa fa-cloud-upload"></i>上传图片</div>
							</div>
							<input type="hidden" name="logo" class="original" required data-helpid="image-help">
						</div>
					</div>
					<div class="weak">请上传JPG或PNG格式的图标，此图标将显示在项目列表中</div>
					<div class="control-help" style="display:none;" id="image-help"></div>
				</div>
			</div>
			<div id="service">
			
			</div>
			
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>服务详情：</label>
				<div class="control">
					<div class="keypress">
						<textarea maxlength="500" name="desc" data-helpid="textarea-help" required></textarea>
					</div>
					<div class="control-help" style="display:none;" id="textarea-help"></div>
					<div>
						<a class="link">洗剪吹模板</a><span class="space"></span>
						<a class="link">洗吹模板</a><span class="space"></span>
						<a class="link">应用：洗剪吹服务详情模板</a>
					</div>
				</div>
			</div>
			<hr />
			<legend>项目限制</legend>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>项目有效期：</label>
				<div class="control">
					<input type="date" required name="expTimeInput" disabled>
					<label><input type="checkbox" checked class="limit"/><span>无限制</span></label>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>定时上架：</label>
				<div class="control">
					<input type="date" required name="name" disabled>
					<label><input type="checkbox" checked class="limit"/><span>无限制</span></label>
					<span class="control-help" style="display:none;"></span>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>定时下架：</label>
				<div class="control">
					<input type="date" required name="name" disabled>
					<label><input type="checkbox" checked class="limit"/><span>无限制</span></label>
					<span class="control-help" style="display:none;"></span>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>限制购买：</label>
				<div class="control">
					<input type="text" required pattern="number" max="99999999"  name="timeLimitInput" placeholder="单人限制购买数"  disabled>
					<label><input type="checkbox" checked class="limit"/><span>无限制</span></label>
					<span class="control-help" style="display:none;"></span>
				</div>
			</div>
			<%if(query.p=="item"){%>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>库存数量：</label>
				<div class="control">
					<input type="text" required pattern="number" max="99999999" min="1" name="totalRepInput"  placeholder="限制销售数量" disabled>
					<label><input type="checkbox" checked class="limit" /><span>无限制</span></label>
					<span class="control-help" style="display:none;"></span>
				</div>
			</div>
			<%}%>
			<%if(query.p=="special"){%>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>项目日库存：</label>
				<div class="control">
					<input type="text" required pattern="number" max="99999999" min="1" name="repertory" placeholder="限制当日销售数量" disabled>
					<label><input type="checkbox" checked class="limit" /><span>无限制</span></label>
					<span class="control-help" style="display:none;"></span>
				</div>
			</div>
			<%}%>
			<div class="control-group">
				<label class="control-label" for="">消费限制：</label>
				<div class="control">
					<input type="text" required pattern="number" max="99999999" min="1" name="useLimit" maxlength="15" placeholder="用户使用限制说明" disabled>
					<label><input type="checkbox" checked class="limit" /><span>无限制</span></label>
					<span class="control-help" style="display:none;"></span>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>限制资格：</label>
				<div class="control">
					<label><input type="checkbox" name="inviteLimit" disabled/><span>限推荐用户购买</span></label>
					<label><input type="checkbox" name="firstLimit" disabled/><span>限首次下单可购买</span></label>
					<label><input type="checkbox" checked class="limit"/><span>无限制</span></label>
				</div>
			</div>
			<hr />
			<legend>价格设置</legend>
			<div class="control-group">
				<label class="control-label" for=""><span class="red">*</span>定价方式：</label>
				<div class="control">
					<label><input class="price-choose" type="radio" name="priceStyle" checked value="1" /><span>无规格，统一价</span></label>
					<label><input class="price-choose" type="radio" name="priceStyle" value="2"/><span>有规格，区间价</span></label>
				</div>
			</div>
			<div class="price-group">
				<div class="control-group">
					<label class="control-label" for=""><span class="red">*</span>原价：</label>
					<div class="control">
						<span>
							<input type="text" required pattern="number" maxlength="5" min="1" name="price">
						</span>
						<input type="text" pattern="number" placeholder="臭美价折扣" class="input-unit" style="width:110px;min-width:0;">
						<span class="unit">%</span>
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for=""><span class="red">*</span>臭美价：</label>
					<div class="control">
						<span>
						<input type="text" required pattern="number" maxlength="5" min="1" name="priceDis">
						</span>
						<input type="text" pattern="number" placeholder="集团价折扣" class="input-unit" style="width:110px;min-width:0;">
						<span class="unit">%</span>
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="">集团价：</label>
					<div class="control">
						<input type="text" required pattern="number" maxlength="5" min="1" name="priceGroup">
					</div>
				</div>
			</div>
			<div class="control-group format-group" style="display:none">
				<label class="control-label" for="">规格选择：</label>
				<div class="form-item">
					<style type="text/css">
						.form-vertical div.control-label{
							width:100px;
							text-align:left;
						}
						.form-item hr{
							margin-top:10px;
							margin-bottom:10px;
							border-style:dotted;
							border-color:#ddd;
						}
						.form-vertical .btn-plus{
							width:30px;
							border-radius:50%;
							min-width:0;
							color:#999;
							border-color:#999;
							height:30px;
							padding:0;
							vertical-align:top;
						}
						.btn-plus i{
							font-size: 28px;
							line-height: 31px;
						}
						.form-item .input-small{
							width:140px!important;
							min-width:0!important;
							margin-bottom:5px;
						}
						.form-item .table input{
							width:100%;
							margin-top:-5px;
							margin-bottom:-5px;
						}
					</style>
					<div class="control-label" >
						<label><input type="checkbox" class="item-checkbox" value="sex" /><span>性别</span></label>
					</div>
					<div class="control">
						<label><input type="checkbox" disabled name="sex" value="男" required/><span>男</span></label>
						<label><input type="checkbox" disabled name="sex" value="女" required/><span>女</span></label>
					</div>
					<hr />
					<div class="control-label" >
						<label><input type="checkbox" class="item-checkbox" value="hairstylist" /><span>造型师</span></label>
					</div>
					<div class="control">
						<input type="text"  class="input-small" disabled maxlength="10" name="hairstylist" nospace/>
						<input type="text"  class="input-small" disabled maxlength="10" name="hairstylist" nospace/>
						<input type="text"  class="input-small" disabled maxlength="10" name="hairstylist" nospace/>
						<input type="text"  class="input-small" disabled maxlength="10" name="hairstylist" nospace/>
						<input type="text"  class="input-small" disabled maxlength="10" name="hairstylist" nospace/>
						<button type="button" class="btn btn-plus" disabled style="cursor: not-allowed;"><i class="fa fa-plus"></i></button>
						<span class="control-help" style="display: none;">请输入造型师</span>
					</div>
					<hr />
					<div class="control-label" >
						<label><input type="checkbox" class="item-checkbox" value="longhair" /><span>发长</span></label>
					</div>
					<div class="control">
						<label><input type="checkbox" disabled name="longhair" value="长发" required/><span>长发</span></label>
						<label><input type="checkbox" disabled name="longhair" value="中发" required/><span>中发</span></label>
						<label><input type="checkbox" disabled name="longhair" value="短发" required/><span>短发</span></label>
						<label><input type="checkbox" disabled name="longhair" value="超长发" required/><span>超长发</span></label>
						<label><input type="checkbox" disabled name="longhair" value="超短发" required/><span>超短发</span></label>
					</div>
					<hr />
					<div class="control-label" >
						<label><input type="checkbox" class="item-checkbox" value="solution" /><span>药水</span></label>
					</div>
					<div class="control">
						<input type="text"  class="input-small" disabled maxlength="10" nospace name="solution"/>
						<input type="text"  class="input-small" disabled maxlength="10" nospace name="solution"/>
						<input type="text"  class="input-small" disabled maxlength="10" nospace name="solution"/>
						<input type="text"  class="input-small" disabled maxlength="10" nospace name="solution"/>
						<input type="text"  class="input-small" disabled maxlength="10" nospace name="solution"/>
						<button type="button" class="btn btn-plus" disabled style="cursor: not-allowed;"><i class="fa fa-plus"></i></button>
						<span class="control-help" style="display: none;">请输入药水</span>
					</div>
					<hr />
					<button type="button" class="btn" id="btn-price" >生成价格表</button>
					<input type="text" pattern="float" placeholder="臭美价折扣" class="input-unit" style="width:110px;min-width:0;"/>
					<span class="unit">%</span>
					<input type="text" pattern="float" placeholder="集团价折扣" class="input-unit" style="width:110px;min-width:0;"/>
					<span class="unit">%</span>
					<input type="hidden" name="normMenu" />
					<input type="hidden" name="normarr" required requiredmsg="请生成价格表" />
					<div class="table" id="format-table">
						
					</div>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for=""></label>
				<div class="control">
					<button class="btn-primary" data-slug="<%=query._?"merchant.update":"merchant.save"%>">提交</button>
				</div>
			</div>
		</form>
		</script>
		</div>
	</div>
	<script type="text/template" id="type-t">
		<%data.forEach(function(item){%>
			<option value="<%=item.typeid%>"><%=item.typename%></option>
		<%})%>
	</script>
	<script type="text/template" id="service-t">
		<%if(data.length>0){%>
			<div class="control-group" id="service">
				<label class="control-label" for="">增值服务：</label>
				<div class="control" >
				<%data.forEach&data.forEach(function(item){%>
					<label><input type="checkbox" name="addedService" value="<%=item.sId%>" checked /><span><%=item.sName%></span></label>
				<%})%>
				</div>
			</div>
		<%}%>
	</script>
	<script type="text/template" id="type1-t">
		<option value="">可选择已有项目新增闲时特价</option>
		<%data.forEach(function(item){%>
			<option value="<%=item.typeid%>"><%=item.typename%></option>
		<%})%>
	</script>
	<script type="text/template" id="project-t">
		<%data.forEach(function(item){%>
			<option value="<%=item.itemid%>"><%=item.itemname%></option>
		<%})%>
	</script>
	<script type="text/template" id="format-table-t">
	<table>
		<thead>
			<tr>
				<th>性别</th>
				<th>造型师</th>
				<th>发长</th>
				<th>药水</th>
				<th>原价</th>
				<th>臭美价</th>
				<th>集团价</th>
			</tr>
		</thead>
		<tbody>
			<%data.forEach(function(item){%>
			<tr>
				<td><%=item.type.sex%></td>
				<td><%=item.type.hairstylist%></td>
				<td><%=item.type.longhair%></td>
				<td><%=item.type.solution%></td>
				<td><input type="text"  /></td>
				<td><input type="text" /></td>
				<td><input type="text" /></td>
			</tr>
			<%})%>
		</tbody>
	</table>
	</script>
	<script type="text/javascript">
		$(function(){
			$(document.body).on('change','.form-item .control-label input',function(){
				$(this).closest('.control-label').next('.control').find('input,button').attr('disabled',!this.checked);
			}).on('click','.form-item .btn-plus',function(){
				var name=$(this).prev().attr('name');
				$(this).before('<input type="text" class="input-small" maxlength="10" nospace name="'+name+'"/>');
				$(this).prev().focus();
			}).on('click','.price-choose',function(){
				if(this.checked&&this.value==1){
					$('.price-group').show().next('.format-group').hide();
				}
				if(this.checked&&this.value==2){
					$('.price-group').hide().next('.format-group').show();
				}
			}).on('change','#type',function(){
				if(this.value==8){
					$('#level').show();
				}else{
					$('#level').hide();
				}
			}).on('_ready','#type,#type1',function(){
				$(this).trigger('change');
			}).on('click','.limit',function(){
				$(this).parent().siblings('input').attr('disabled',this.checked);
				$(this).parent().siblings('label').children('input').attr('disabled',this.checked);
			});
			$('#form').one('_ready',function(){
				lib.puploader.image({
					browse_button: 'imageUpload',
					auto_start:true,
					filters: {
						mime_types : [
							{ title : "Image files", extensions : "jpg,png,jpeg" }
						]
					}
				});
				$('input[name="price"]').on('pass',function(){
					$('input[name="priceDis"],input[name="priceGroup"]').attr('max',this.value);
				});
				var $format=$('.format-group');
				$('#btn-price').on('click',function(){
					var itemCheckbox=$('.item-checkbox:checked');
					if(itemCheckbox.length==0){
						parent.lib.popup.alert({text:'至少要选择一个规格项'})
					}else{
						$format.find('input[type="text"],input[type="checkbox"]').blur();
						if($format.find('.control-help:visible').length==0){
							var sexArr=[];
							$('input[name="sex"]:checked').each(function(){
								sexArr.push({sex:this.value});
							});
							var longhairArr=[];
							$('input[name="longhair"]:checked').each(function(){
								longhairArr.push({longhair:this.value});
							});
							var hairstyArr=[];
							$('input[name="hairstylist"]').each(function(){
								if(this.value){
									hairstyArr.push({hairstylist:this.value});
								}
							});
							var solutionArr=[];
							$('input[name="solution"]').each(function(){
								if(this.value){
									solutionArr.push({solution:this.value});
								}
							});
							var array=[];
							if(sexArr.length>0){
								array.push(sexArr);
							}
							if(longhairArr.length>0){
								array.push(longhairArr);
							}
							if(hairstyArr.length>0){
								array.push(hairstyArr);
							}
							if(solutionArr.length>0){
								array.push(solutionArr);
							}
							var data=[];
							if(array.length>0){
								array[0].forEach(function(item1){
									if(array[1]){
										array[1].forEach(function(item2){
											if(array[2]){
												array[2].forEach(function(item3){
													if(array[3]){
														array[3].forEach(function(item4){
															data.push({type:$.extend({},item1,item2,item3,item4)});
														});
													}else{
														data.push({type:$.extend({},item1,item2,item3)});
													}
												});
											}else{
												data.push({type:$.extend({},item1,item2)});
											}
										});
									}else{
										data.push({type:$.extend({},item1)});
									}
								});
							}
							$('input[name="normarr"]').val(JSON.stringify(data));
							var normMenu=[];
							itemCheckbox.each(function(){
								normMenu.push(this.value);
							})
							$('input[name="normMenu"]').val(JSON.stringify(normMenu));
							$('#format-table').html(lib.ejs.render({text:$('#format-table-t').html()},{data:data}));
						}
					}
				});
				$format.on('blur','.input-small',function(e){
					if(this.disabled) return;
					var $this=$(this);
					var arr=[];
					$this.parent().children('input').each(function(){
						if(this.value){
							arr.push(this.value);
						}
					})
					if(arr.length==0){
						$this.siblings('.control-help').show();
					}else{
						$this.siblings('.control-help').hide();
					}
					e.stopPropagation();
				});
			});
		});
	</script>
  </body>
</html>