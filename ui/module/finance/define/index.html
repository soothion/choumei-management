<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <title>臭美管理后台</title>
        <script type="text/javascript" src="/js/include.js"></script>
    </head>
    <body>
        <div class="breadcrumb">
           <a>收款管理 </a><span>&gt;</span><a href="index.html">付款确认</a>
		   <div class="flex-box">
			<div class="flex-item">
				<h4>付款确认</h4>
			</div>
			<div>
				
			</div>
		</div>
        </div>
        <div class="wrapper">
			<form data-role="hash">	
				<div class="input-group placeholder-switch">			
					<select class="select" name="key" id="select">
						<option value="1" data-placeholder="请输入店铺名称">店铺名称</option>
						<option value="2" data-placeholder="请输入店铺编号">店铺编号</option>
						<option value="3" data-placeholder="请输入商户名称">商户名称</option>
					</select>
					<input type="text" placeholder="请输入店铺名称" name="keyword">
				</div>
				<label>要求付款日期：</label>
				<span class="date-group">
					<input type="date" data-role="start"  name="pay_time_min" placeholder="YYYY-MM-DD"/>
					到<input type="date" data-role="end"  name="pay_time_max" placeholder="YYYY-MM-DD"/>
				</span>
				<button class="btn" type="submit">搜索</button>
			</form>
			<form action="pay_manage/export" data-role="export" ><button class="btn" ><i class="fa fa-file-excel-o"></i> 导出</button></form>
           <div class="table" ajat="pay_manage/index?<%=query._%>#domid=table&tempid=table-t" id="table">
			<script type="text/template" id="table-t">
                <table>
                    <thead>
                        <tr>
							<th width="50px"><label class="select-all"><input type="checkbox"/><span>全选</span></label></th>
                            <th>序号</th>
							<th>店铺编号</th>                       
							<th>店铺名称</th>
							<th>付款单号</th>						 
                            <th><a data-role="hash" href="#page=1&sort_key=type&sort_type=<%=query.sort_type=="desc"?"asc":"desc"%>">付款类型 <i class="fa fa-sort"></i></a></th>                          
                            <th>付款金额</th>
							<th><a data-role="hash" href="#page=1&sort_key=pay_type&sort_type=<%=query.sort_type=="desc"?"asc":"desc"%>">付款方式 <i class="fa fa-sort"></i></a></th>							
							<th><a data-role="hash" href="#page=1&sort_key=require_day&sort_type=<%=query.sort_type=="desc"?"asc":"desc"%>">要求付款日期 <i class="fa fa-sort"></i></a></th>			       
                            <th><a data-role="hash" href="#page=1&sort_key=confirm_at&sort_type=<%=query.sort_type=="desc"?"asc":"desc"%>">审批日期 <i class="fa fa-sort"></i></a></th>
                            <th>制单人</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
               <tbody>
			   <%if(data.data){%>
				<%var type=["","付交易代收款","付业务投资款"]%>
				<%var pay_type=["","银行存款","账扣返还","现金","支付宝","财付通"]%>
				<%var state=["","待提交","待审批","待付款","已付款"]%>
				<%data.data.forEach(function(item,i){%>
				<tr>
					<td><label><input type="checkbox" name="ids" data-price="<%=item.money%>" form="form" value="<%=item.id%>"/><span></span></label></td>
					<td><%=i+1%></td>
					<td><%=item.salon?item.salon.sn:""%></td>
					<td><%=item.salon?item.salon.salonname:""%></td>
					<td><%=item.code%></td>
					<td><%=type[item.type]%></td>
					<td><%=item.money%></td>
					<td><%=pay_type[item.pay_type]%></td>
					<td><%=item.require_day%></td>				 
					<td><%=item.confirm_at%></td>
					<td><%=item.make_user?item.make_user.name:""%></td>					 
					<td><%=state[item.state]%></td>
					<%
						var page="invest";
						if(item.type==1){
							if(item.pay_type==2){
								page="pay-account";
							}else{
								page="collection";
							}
						}
					%>
					<td><a class="link" href="detail-<%=page%>.html?id=<%=item.id%>" data-slug="shop_count.show,shop_count.update">查看</a></td>
                  </tr>
				  <%})%>
				  <%}%>
              </tbody>
            </table>
			<%if(data.data&&data.data.length>0){%>
			<div class="table-bottom">
				<label class="select-all"><input type="checkbox"/><span>全选</span></label>
				<button class="btn" data-define="1">确认付款</button><span class="space"></span><button class="btn" data-define="2">拒绝付款</button>
			</div>
			<%}%>
            <div class="pager"> </div>
			</script>
        </div>
    </div>
	<script type="text/javascript">
		$(function(){
			$('#table').on('click','.table-bottom button',function(){
				var $this=$(this);
				var checked=$('tbody input:checked');
				var count=0;
				var data={
					ids:[]
				}
				checked.each(function(){
					count+=parseFloat($(this).data('price'));
					data.ids.push(this.value);
				});
				if(checked.length==0){
					parent.lib.popup.alert({text:"请选择店铺"});
					return;
				}
				var confirmText="";
				if($this.data('define')==1){
					data.do=1;
					confirmText="你正在给5家店铺支付￥"+count+"，是否继续？"
				}
				if($this.data('define')==2){
					data.do=2;
					confirmText="你正在拒绝"+data.ids.length+"家店铺的付款请求，是否继续？"
				}
				data.ids=data.ids.toString();
				parent.lib.popup.confirm({
					text:confirmText,
					define:function(){
						lib.ajax({
							url:"pay_manage/confirm",
							type:"POST",
							data:data,
							success:function(data){
								parent.lib.popup.result({
									bool:data.result,
									define:function(){
										if(data.result==1){
											location.reload();
										}
									}
								});
							}
						});
					}
				});
			});
		});
	</script>
</body>
</html>